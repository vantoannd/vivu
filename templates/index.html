<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bản đồ Du lịch Địa phương</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/fontawesome-free-6.5.2-web/css/all.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Latest compiled and minified CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Latest compiled JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <style>
        #map {
            height: 953px;
            width: 100%;
        }
    </style>
</head>
<body>
    
    <!-- <a href="{{ url_for('search_locations') }}">Search Locations</a> -->

    <div class="map">
        <div id="map"></div>
        <button class="location-user" onclick="locateUser()"><i class="fa-solid fa-crosshairs"></i></button>
        
        
        <form class="form-input" method="GET" action="{{ url_for('index') }}">
            <button class="btn-list" type="button" data-bs-toggle="offcanvas" data-bs-target="#demo">
                <i class="fa-solid fa-bars"></i>
            </button>
            <input class="input-search" type="text" id="keyword" name="keyword" placeholder="Tìm kiếm...">
            <button class="btn-search" type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
            <a class="btn-way" href="{{ url_for('route_suggestions') }}"><i class="fa-solid fa-square-up-right"></i></a>
        </form>
    </div>
    
    <div class="offcanvas offcanvas-start" id="demo">
        <div class="offcanvas-header">
            <h1 class="offcanvas-title">Bản đồ du lịch</h1>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <label for="category">Chọn loại địa điểm:</label>
            <select id="category" name="category" onchange="filterByCategory()">
                <option value="">Tất cả</option>
                <option value="Historical">Lịch sử</option>
                <option value="Natural">Thiên nhiên</option>
                <option value="Cultural">Văn hóa</option>
            </select>
            <h2>Locations</h2>
            <ul>
                {% for location in locations %}
                    <li>
                        <h3>{{ location.name }}</h3>
                        <p>{{ location.description }}</p>
                        {% if location.image_data %}
                            <img src="data:image/jpeg;base64,{{ location.image_data | b64encode }}" alt="Image of {{ location.name }}" style="width:200px;">
                        {% endif %}
                        <p>Latitude: {{ location.latitude }}, Longitude: {{ location.longitude }}</p>
                    </li>
                {% endfor %}
            </ul>
            <button type="button" class="btn-add_location" data-bs-toggle="modal" data-bs-target="#myModal">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>
    </div>
    <div class="modal fade" id="myModal">
        <div class="modal-dialog">
          <div class="modal-content ">
      
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Thêm địa điểm</h4>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
      
            <!-- Modal body -->
            <div class="modal-body">
                <form action="{{ url_for('add_location') }}" method="post" enctype="multipart/form-data">
                    <label for="name">Tên:</label><br>
                    <input type="text" id="name" name="name"><br>
                    <label for="description">Mô Tả:</label><br>
                    <textarea id="description" name="description"></textarea><br>
                    <label for="latitude">Vĩ Độ:</label><br>
                    <input type="text" id="latitude" name="latitude"><br>
                    <label for="longitude">Kinh Độ:</label><br>
                    <input type="text" id="longitude" name="longitude"><br>
                    <label for="rating">Đánh Giá:</label><br>
                    <input type="number" id="rating" name="rating" min="1" max="5"><br>
                    <label for="category">Loại:</label><br>
                    <select id="category" name="category">
                        <option value="Historical">Lịch sử</option>
                        <option value="Natural">Thiên nhiên</option>
                        <option value="Cultural">Văn hóa</option>
                    </select><br><br>
                    <label for="image">Ảnh:</label><br>
                    <input type="file" id="image" name="image" accept="image/*"><br><br>
                    <input type="submit" class="btn btn-info" value="Thêm Địa Điểm">
                </form>
            </div>
      
            <!-- Modal footer -->
            <div class="modal-footer">
              <a type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</a>
            </div>
      
          </div>
        </div>
    </div>
  
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([21.028511, 105.804817], 13); // Example coordinates for Hanoi, Vietnam

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Fetch locations from Flask endpoint
        fetch('/locations?keyword={{ request.args.get("keyword", "") }}')
            .then(response => response.json())
            .then(data => {
                data.locations.forEach(location => {
                    L.marker([location.latitude, location.longitude])
                        .bindPopup(`<b>${location.name}</b><br>${location.description}`)
                        .addTo(map);
                });
            });

        function loadLocations(category) {
            fetch('/api/locations' + (category ? '?category=' + category : ''))
                .then(response => response.json())
                .then(data => {
                    data.forEach(location => {
                        var marker = L.marker([location.latitude, location.longitude]).addTo(map);
                        marker.bindPopup(`<b>${location.name}</b><br>${location.description}<br><img src="${location.image_data}" width="100"><br>Rating: ${location.rating}`);
                    });
                });
        }

        function filterByCategory() {
            var category = document.getElementById('category').value;
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            loadLocations(category);
        }
        var userIcon = L.icon({
            iconUrl: 'https://shop.mixigaming.com/wp-content/uploads/2019/06/cropped-logo-mixi-tét-1-32x32.png',
            //shadowUrl: 'leaf-shadow.png',
        
            iconSize:     [38, 38], // size of the icon
            //shadowSize:   [50, 64], // size of the shadow
            iconAnchor:   [38, 38], // point of the icon which will correspond to marker's location
            //shadowAnchor: [4, 62],  // the same for the shadow
            popupAnchor:  [-19, -38] // point from which the popup should open relative to the iconAnchor
        });

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    var userMarker = L.marker([lat, lng], {icon: userIcon}).addTo(map);
                    userMarker.bindPopup("Bạn đang ở đây!").openPopup();
                    map.setView([lat, lng], 15);
                }, function (error) {
                    alert("Lỗi khi xác định vị trí: " + error.message);
                });
            } else {
                alert("Trình duyệt của bạn không hỗ trợ định vị vị trí.");
            }
        }

        loadLocations();
        fetch('/api/locations')
            .then(response => response.json())
            .then(data => {
                data.forEach(location => {
                    var marker = L.marker([location.latitude, location.longitude]).addTo(map);
                    marker.bindPopup(`<b>${location.name}</b><br>${location.description}<br><img src="${location.image_url}" width="100"><br>Rating: ${location.rating}`);
                    
                    var listItem = document.createElement('li');
                    listItem.textContent = location.name;
                    var deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Xóa';
                    deleteButton.addEventListener('click', function() {
                        deleteLocation(location.id);
                    });
                    listItem.appendChild(deleteButton);
                    document.getElementById('locationsList').appendChild(listItem);
                });
            });

        function deleteLocation(locationId) {
            fetch(`/api/location/${locationId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    alert('Đã xóa địa điểm thành công!');
                    location.reload();
                } else {
                    alert('Đã xảy ra lỗi khi xóa địa điểm.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        var popup = L.popup();

        function onMapClick(e) {
            popup
                .setLatLng(e.latlng)
                .setContent("You clicked the map at " + e.latlng.toString())
                .openOn(map);
        }

        map.on('click', onMapClick);
    </script>
</body>
</html>
